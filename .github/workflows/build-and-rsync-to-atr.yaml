name: build-and-rsync-to-atr
on: [workflow_dispatch]
permissions: { contents: read }

jobs:
  build-and-upload:
    runs-on: ubuntu-22.04
    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout (shallow, no persisted credentials)
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4.3.0
        with:
          fetch-depth: 1
          persist-credentials: false

      - name: Build dists (sdist + wheel) in python:3.12-slim
        run: |
          set -euxo pipefail
          docker run --rm -v "$PWD:/work" -w /work python:3.12-slim bash -lc '
            set -euxo pipefail
            python -m pip install -U pip build
            python -m build --sdist --wheel
          '

      - name: Show dist hashes
        run: |
          set -euxo pipefail
          ls -l dist
          sha256sum dist/*

      - name: Upload to ATR using a local composite action
        uses: apache/tooling-actions/upload-to-atr@6850e4ef8e1be83cb18f23e2c855a2f476df75bd
        with:
          asf-uid: sbp
          project: tooling
          version: 0.3
